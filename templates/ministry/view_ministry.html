{# vim: foldmethod=marker tabstop=2 shiftwidth=2:
    templates/ministry/view_ministry.html
#}
{% extends "layout.html" %}

{% from "macros/layout/misc_layout.html" import section_start, section_close %}
{% from "macros/parts/comments_section.html" import comments_section %}
{% from "macros/parts/gallery.html" import gallery %}
{% from "macros/parts/like_button.html" import like_button %}
{% from "macros/parts/tag_chips.html" import tag_chips %}

{% import "cards.html" as card %}

{% set AUTH = (request.user == ministry.admin or request.user in ministry.reps.all()) %}

{% block title %}{{ ministry.name }}{% endblock %}

{% block body %}
  <div ng-app="LON">
    <input type="hidden" id="current_object_json" value="{{ ministry.json }}">
    <input type="hidden" id="ministry_id" value="{{ ministry.id }}">
    {% if AUTH == None %}
      {% set AUTH = request.user == ministry.admin or request.user in ministry.reps.all() %}
    {% endif %}

    {# {{{ Top Section Overlay #}
    {% if ministry.banner_img %}
      <div class="parallax-container" style='height: 250px;'>
        <div class="parallax" style="z-index: 500;">
          <img src="{{ ministry.banner_img.url }}" alt="">
        </div>
      </div>
    {% endif %}
    {# }}} #}

    <div id="{{ id }}" class="section">
      <div class="wrapper" ng-controller="ministryCtrl">

        <h1 class="action-header truncate">
          {% if request.user.is_authenticated %}
            <a class="dropdown-trigger" href="#" data-target="actionMenu">
              {{ ministry.name.upper() }}
              <i class="material-icons">arrow_drop_down</i>
            </a>
          {% else %}
            {{ ministry.name.upper() }}
          {% endif %}
        </h1>

        {# {{{ Action Menu #}
        <ul id="actionMenu" class="dropdown-content">
          {% if AUTH %}
            {% for opt in ministry_admin_urls(ministry) %}
              <li>
                <a href="{{ url_for(opt['reverse_url'], kwargs=opt['kwargs']) }}">
                  <i class="material-icons">{{ opt['icon'] }}</i>
                  {{ opt['label'] }}
                </a>
              </li>
            {% endfor %}
          {% elif not AUTH %}
            <li>
              <a href="{{ url_for('ministry:request_to_be_rep', kwargs={'ministry_id': ministry.id}) }}">
                Request to be a representative
              </a>
            </li>
          {% endif %}
        </ul>
        {# }}} #}

        <div class="row">

          <div class="col l3 s12">
            {{ like_button(ministry, request) }}
          </div>

          <div class="col l4 s12" style="margin: auto 0">
            <p class="section-info">
              <span># of Projects:</span>&nbsp;
              {{ len(ministry.campaigns.all()) }}
              <br>
              <span>Total Donations:</span>&nbsp;
              {{ ministry.donated }}
              <br>
              <span>Views:</span>&nbsp;
              {{ ministry.views }}
            </p>
          </div>

        </div><!-- /layout -->

        {% if ministry.description %}
          <h3>Description:</h3>
          <p class="flow-text">{{ ministry.description|safe }}</p>
        {% endif %}

        {% if ministry.has_tags %}
          <div id="tags">
            <h5>Tags:</h5>
            {{ tag_chips(ministry) }}
          </div>
        {% endif %}

        <div>
          <h3>Ministry Information:</h3>

          <div class="row sm-links">
            <div class="col s3 m2 l1">
              {% if ministry.facebook %}
                <a href="{{ ministry.facebook }}" class="btn blue white-text">
                  <i class="fa fa-facebook"></i>
                </a>&nbsp;
              {% endif %}
            </div><!-- facebook -->
            <div class="col s3 m2 l1">
              {% if ministry.instagram %}
                <a href="{{ ministry.instagram }}" class="btn blue darken-4 white-text">
                  <i class="fa fa-instagram"></i>
                </a>
              {% endif %}
            </div><!-- instagram -->
            <div class="col s3 m2 l1">
              {% if ministry.twitter %}
                <a href="{{ ministry.twitter }}" class="btn light-blue white-text">
                  <i class="fa fa-twitter"></i>
                </a>
              {% endif %}
            </div><!-- twitter -->
            <div class="col s3 m2 l1">
              {% if ministry.youtube %}
                <a href="{{ ministry.youtube }}" class="btn red white-text">
                  <i class="fa fa-youtube"></i>
                </a>
              {% endif %}
            </div><!-- youtube -->
          </div><!-- social media links -->

          <div class="section-info">
            <span>Website:</span>&nbsp;
            {% if ministry.website %}
              <a href="{{ ministry.website }}">{{ ministry.website.split("://")[1] }}</a><br>
            {% endif %}

            {% set info = {
                'phone_number': 'Phone',
                'address': 'Address',
                'founded': 'Date Founded',
                'staff': 'Number of Staff Members',
                'pub_date': 'Profile Created'
            } %}
            {% for attr, str in info.items() %}
              {% if ministry.__dict__[attr] %}
                <span>{{ str }}:</span>&nbsp;
                {% if attr == 'pub_date' %}
                  {{ f_time(ministry.__dict__[attr]) }}
                {% else %}
                  {{ ministry.__dict__[attr] }}
                {% endif %}
                <br>
              {% endif %}
            {% endfor %}
          </div><!-- /.section-info -->

        </div><!-- /row -->

        {{ comments_section(ministry, 'ministry', request, form=form, csrf_token=csrf_token) }}

      </div>
    </div>

    {# TODO: move comments section to tabs #}

    <section class="wrapper">
      <!-- ministry/ministry_details -->

      {{ card.card_area(all_news, campaigns=(True, campaigns), AUTH=AUTH, images=images) }}

    </section>
  </div>
{% endblock %}


{% block scripts %}
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.6/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.6/angular-animate.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.6/angular-aria.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.6/angular-messages.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.12/angular-material.min.js"></script>

  {% set page_assets = (
  'app.module.js',
  'app.config.js',
  'services/object.service.js',
  'services/like__button.service.js',
  'services/gallery.service.js',
  'ministry/ministry.controller.js',
  ) %}
  {% for f in page_assets %}
    <script src="{{ static('app/%s' % f) }}"></script>
  {% endfor %}

{% endblock %}


{% block css %}
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.12/angular-material.min.css">
{% endblock %}
